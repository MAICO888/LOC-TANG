<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const btnClear = document.getElementById('btnClear');
const btnExport = document.getElementById('btnExport');
const tableWrap = document.getElementById('tableWrap');
const actions = document.getElementById('actions');

let mergedData = [];
let filteredData = []; // D·ªØ li·ªáu sau khi l·ªçc

drop.addEventListener('click', ()=> fileInput.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', e=> handleFiles(e.target.files));
btnClear.addEventListener('click', clearAll);

function handleFiles(fileList){
  if(typeof XLSX==='undefined'){ alert('Thi·∫øu XLSX!'); return; }
  const files = Array.from(fileList);
  mergedData = [];
  tableWrap.innerHTML=''; actions.style.display='none';
  let pending = files.length;
  files.forEach(file=>{
    const r = new FileReader();
    r.onload = evt=>{
      try{
        const wb = XLSX.read(evt.target.result,{type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        for(let i=1;i<rows.length;i++){
          const row=rows[i];
          const a=row[2]||''; // C·ªôt C -> A
          const b=row[8]||''; // C·ªôt I -> B
          const c=row[14]||''; // C·ªôt O -> C
          if(a||b||c) mergedData.push({A:a,B:b,C:c});
        }
      } catch(err){ console.error(err); alert('L·ªói ƒë·ªçc file '+file.name); }
      finally{ pending--; if(pending===0) finalizeAndRender(); }
    };
    r.readAsArrayBuffer(file);
  });
}

// Ph√¢n lo·∫°i c·ªôt B -> D
function classifyB(b){
  const val = parseFloat(String(b).replace(/,/g,''))||0;
  if(val<100000) return 'ÈªòËÆ§Â±Ç';
  if(val<200000) return 'ÂçÅ‰∏á-10‰∏á';
  if(val<300000) return '‰∫åÂçÅ‰∏á-20‰∏á';
  if(val<500000) return '‰∏âÂçÅ‰∏á-30‰∏á';
  if(val<610000) return '‰∫îÂçÅ‰∏á-50‰∏á';
  if(val<1000000) return 'ÂÖ≠ÂçÅ‰∏Ä‰∏á-61‰∏á';
  if(val<2000000) return '‰∏ÄÁôæ‰∏á-100‰∏á';
  if(val<3000000) return '‰∫åÁôæ‰∏á-200‰∏á';
  if(val<5000000) return '‰∏âÁôæ‰∏á-300‰∏á';
  if(val<10000000) return '‰∫îÁôæ‰∏á-500‰∏á';
  if(val<30000000) return '‰∏ÄÂçÉ‰∏á-1000‰∏á';
  if(val<50000000) return '‰∏âÂçÉ‰∏á-3000‰∏á';
  return '‰∫îÂçÉ‰∏á-5000‰∏á';
}

function finalizeAndRender(){
  mergedData = mergedData.map(r=>{
    const D = classifyB(r.B);
    return {...r, D};
  });

  mergedData = mergedData.filter(r=>String(r.C).trim()!==String(r.D).trim());

  const mapA = new Map();
  mergedData.forEach(r=>{
    const key = r.A;
    const valB = parseFloat(String(r.B).replace(/,/g,'')) || 0;
    if(!mapA.has(key) || valB > mapA.get(key).BVal){
      mapA.set(key,{...r,BVal: valB});
    }
  });

  mergedData = Array.from(mapA.values()).map(o=>({A:o.A,D:o.D}));
  filteredData = mergedData; // ban ƒë·∫ßu hi·ªÉn th·ªã to√†n b·ªô
  renderTable(filteredData);
}

function renderTable(rows){
  if(!rows.length){ 
    tableWrap.innerHTML='<div class="small">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</div>'; 
    actions.style.display='none'; 
    return; 
  }

  // Th√™m input l·ªçc
  let html = `
  <div class="controls" style="margin-bottom:8px">
    <input id="filterA" placeholder="üîç L·ªçc c·ªôt A..." style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;flex:1">
    <input id="filterD" placeholder="üîç L·ªçc c·ªôt D..." style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;flex:1">
  </div>
  `;

  html += '<table id="dataTable"><thead><tr><th>STT</th><th>A</th><th>D</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html+=`<tr><td>${i+1}</td><td class="colA">${escapeHtml(r.A)}</td><td>${escapeHtml(r.D)}</td></tr>`;
  });
  html+='</tbody></table>'; 
  tableWrap.innerHTML=html; 
  actions.style.display='flex';

  // S·ª± ki·ªán l·ªçc
  const filterA = document.getElementById('filterA');
  const filterD = document.getElementById('filterD');
  filterA.addEventListener('input', applyFilters);
  filterD.addEventListener('input', applyFilters);

  // Double click ƒë·ªïi m√†u
  document.querySelectorAll('#dataTable .colA').forEach(td=>{
    td.addEventListener('dblclick', ()=>{
      const tr = td.parentElement;
      tr.style.backgroundColor = 
        tr.style.backgroundColor === 'orange' ? '' : 'orange';
    });
  });
}

function applyFilters(){
  const valA = document.getElementById('filterA').value.trim().toLowerCase();
  const valD = document.getElementById('filterD').value.trim().toLowerCase();
  filteredData = mergedData.filter(r=>{
    const aMatch = r.A.toLowerCase().includes(valA);
    const dMatch = r.D.toLowerCase().includes(valD);
    return aMatch && dMatch;
  });
  renderTable(filteredData);
}

btnExport.addEventListener('click', ()=>{
  if(!filteredData.length){ alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t'); return; }
  const out=[['A','D']];
  filteredData.forEach(r=> out.push([r.A,r.D]));
  const ws=XLSX.utils.aoa_to_sheet(out);
  const wb=XLSX.utils.book_new(); 
  XLSX.utils.book_append_sheet(wb,ws,'KetQua'); 
  XLSX.writeFile(wb,'LOC-TANG_Ketqua.xlsx');
});

function escapeHtml(s){ 
  return s===null||s===undefined?'':String(s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
}

function clearAll(){ 
  if(!confirm('B·∫°n c√≥ mu·ªën x√≥a d·ªØ li·ªáu hi·ªán t·∫°i?')) return; 
  mergedData=[]; filteredData=[];
  tableWrap.innerHTML=''; actions.style.display='none'; fileInput.value=''; 
}
</script>
