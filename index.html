<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LOC-TANG ‚Äî G·ªôp & Ph√¢n lo·∫°i B‚ÜíD</title>
<style>
:root{--blue:#0b66c3;--bg:#f3f7fb;--muted:#666}
body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:16px;color:#123}
h1{color:var(--blue);text-align:center;margin-bottom:8px}
#drop{border:2px dashed var(--blue);background:#eaf3ff;padding:20px;border-radius:10px;text-align:center;cursor:pointer}
#drop.drag{background:#dfeffd}
.controls{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
input[type=file]{display:none}
button{background:var(--blue);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;color:var(--blue);border:1px solid #cfe4ff}
.small{font-size:13px;color:var(--muted)}
#tableWrap{margin-top:14px}
table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
th,td{padding:8px;border:1px solid #e6eef9;text-align:center;font-size:13px}
thead th{background:var(--blue);color:#fff;position:sticky;top:0}
.actions{display:flex;gap:8px;align-items:center;margin-top:10px}
.highlight{background:orange !important;color:#111}
@media(max-width:700px){ .controls{flex-direction:column;align-items:flex-start} .actions{flex-direction:column} }
</style>
</head>
<body>

<h1>L·ªåC T·∫¶NG</h1>

<div id="drop" title="K√©o & th·∫£ file Excel v√†o ƒë√¢y">
  <div style="font-size:16px">üìÇ K√©o & Th·∫£ Nhi·ªÅu File Excel ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn</div>
  <div class="small" style="margin-top:6px">D·ªØ li·ªáu ch√≠nh: h√†ng t·ª´ <b>2</b> tr·ªü xu·ªëng ‚Äî A ‚Üê C, B ‚Üê I, C ‚Üê O. C·ªôt D t·ª± ph√¢n lo·∫°i theo gi√° tr·ªã B. Lo·∫°i b·ªè d√≤ng C=D. Tr√πng A gi·ªØ d√≤ng c√≥ B l·ªõn nh·∫•t. Xu·∫•t Excel ch·ªâ A & D.</div>
  <input id="fileInput" type="file" accept=".xlsx,.xls" multiple />
</div>

<div class="controls">
  <button id="btnClear" class="ghost">üßπ X√≥a b·∫£ng / T·∫£i l·∫°i</button>
  <div style="flex:1"></div>
  <div class="small">Ch·∫°y online qua CDN.</div>
</div>

<div class="actions" id="actions" style="display:none">
  <button id="btnExport">‚¨áÔ∏è Xu·∫•t LOC-TANG_Ketqua.xlsx (A & D)</button>
  <button id="btnExportHighlighted" class="ghost" title="Xu·∫•t nh·ªØng h√†ng ƒëang ƒë∆∞·ª£c t√¥ m√†u">‚¨áÔ∏è Xu·∫•t h√†ng t√¥ m√†u</button>
</div>

<div id="tableWrap"></div>

<!-- SheetJS CDN (ph·∫£i load tr∆∞·ªõc script ch√≠nh) -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const btnClear = document.getElementById('btnClear');
const btnExport = document.getElementById('btnExport');
const btnExportHighlighted = document.getElementById('btnExportHighlighted');
const tableWrap = document.getElementById('tableWrap');
const actions = document.getElementById('actions');

let mergedData = [];    // to√†n b·ªô d·ªØ li·ªáu A & D sau x·ª≠ l√Ω
let filteredData = [];  // d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã (sau l·ªçc)
let highlightedSet = new Set(); // l∆∞u gi√° tr·ªã A c·ªßa c√°c h√†ng t√¥ m√†u (d√πng ƒë·ªÉ export)

drop.addEventListener('click', ()=> fileInput.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', e=> handleFiles(e.target.files));
btnClear.addEventListener('click', clearAll);

function handleFiles(fileList){
  if(typeof XLSX==='undefined'){ alert('Thi·∫øu XLSX!'); return; }
  const files = Array.from(fileList);
  mergedData = [];
  filteredData = [];
  highlightedSet.clear();
  tableWrap.innerHTML=''; actions.style.display='none';
  if(files.length===0) return;
  let pending = files.length;
  files.forEach(file=>{
    const r = new FileReader();
    r.onload = evt=>{
      try{
        const wb = XLSX.read(evt.target.result,{type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        for(let i=1;i<rows.length;i++){
          const row=rows[i];
          const a=row[2]||''; // C -> A (index 2)
          const b=row[8]||''; // I -> B (index 8)
          const c=row[14]||''; // O -> C (index 14)
          if(a||b||c) mergedData.push({A:a,B:b,C:c});
        }
      } catch(err){ console.error(err); alert('L·ªói ƒë·ªçc file '+file.name); }
      finally{ pending--; if(pending===0) finalizeAndRender(); }
    };
    r.readAsArrayBuffer(file);
  });
}

// Ph√¢n lo·∫°i c·ªôt B -> D (gi·ªØ nguy√™n ch·ª©c nƒÉng c≈©)
function classifyB(b){
  const val = parseFloat(String(b).replace(/,/g,''))||0;
  if(val<100000) return 'ÈªòËÆ§Â±Ç';
  if(val<200000) return 'ÂçÅ‰∏á-10‰∏á';
  if(val<300000) return '‰∫åÂçÅ‰∏á-20‰∏á';
  if(val<500000) return '‰∏âÂçÅ‰∏á-30‰∏á';
  if(val<610000) return '‰∫îÂçÅ‰∏á-50‰∏á';
  if(val<1000000) return 'ÂÖ≠ÂçÅ‰∏Ä‰∏á-61‰∏á';
  if(val<2000000) return '‰∏ÄÁôæ‰∏á-100‰∏á';
  if(val<3000000) return '‰∫åÁôæ‰∏á-200‰∏á';
  if(val<5000000) return '‰∏âÁôæ‰∏á-300‰∏á';
  if(val<10000000) return '‰∫îÁôæ‰∏á-500‰∏á';
  if(val<30000000) return '‰∏ÄÂçÉ‰∏á-1000‰∏á';
  if(val<50000000) return '‰∏âÂçÉ‰∏á-3000‰∏á';
  return '‰∫îÂçÉ‰∏á-5000‰∏á';
}

function finalizeAndRender(){
  // G√°n D
  mergedData = mergedData.map(r=>{
    const D = classifyB(r.B);
    return {...r, D};
  });

  // Lo·∫°i b·ªè C == D
  mergedData = mergedData.filter(r=> String(r.C).trim() !== String(r.D).trim() );

  // L·ªçc tr√πng A gi·ªØ B l·ªõn nh·∫•t
  const mapA = new Map();
  mergedData.forEach(r=>{
    const key = String(r.A);
    const valB = parseFloat(String(r.B).replace(/,/g,'')) || 0;
    if(!mapA.has(key) || valB > mapA.get(key).BVal){
      mapA.set(key,{...r,BVal: valB});
    }
  });

  mergedData = Array.from(mapA.values()).map(o=>({A:o.A,D:o.D}));
  filteredData = mergedData.slice();
  renderTable(filteredData);
}

function renderTable(rows){
  if(!rows.length){
    tableWrap.innerHTML = '<div class="small">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</div>';
    actions.style.display='none';
    return;
  }

  // HTML: 2 input l·ªçc + b·∫£ng
  let html = `
  <div class="controls" style="margin-bottom:8px">
    <input id="filterA" placeholder="üîç L·ªçc c·ªôt A..." style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;flex:1">
    <input id="filterD" placeholder="üîç L·ªçc c·ªôt D..." style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;flex:1">
  </div>
  `;

  html += '<table id="dataTable"><thead><tr><th>STT</th><th>A</th><th>D</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    // D√πng data-key ƒë·ªÉ d·ªÖ x√°c ƒë·ªãnh khi export/toggle
    const safeA = escapeHtml(r.A);
    const safeD = escapeHtml(r.D);
    html += `<tr data-key="${escapeHtml(String(r.A))}"><td>${i+1}</td><td class="colA">${safeA}</td><td class="colD">${safeD}</td></tr>`;
  });
  html += '</tbody></table>';
  tableWrap.innerHTML = html;
  actions.style.display='flex';

  // G·∫Øn event l·ªçc
  const filterA = document.getElementById('filterA');
  const filterD = document.getElementById('filterD');
  filterA.addEventListener('input', applyFilters);
  filterD.addEventListener('input', applyFilters);

  // G·∫Øn double-click: toggle class .highlight tr√™n <tr>
  document.querySelectorAll('#dataTable .colA').forEach(td=>{
    td.addEventListener('dblclick', (ev)=>{
      const tr = td.parentElement;
      const key = String(tr.getAttribute('data-key') || '');
      if(tr.classList.contains('highlight')){
        tr.classList.remove('highlight');
        highlightedSet.delete(key);
      } else {
        tr.classList.add('highlight');
        highlightedSet.add(key);
      }
    });
  });

  // Khi render m·ªõi, n·∫øu c√≥ A ƒë√£ highlight tr∆∞·ªõc ƒë√≥ th√¨ set l·∫°i class
  if(highlightedSet.size){
    document.querySelectorAll('#dataTable tbody tr').forEach(tr=>{
      const key = String(tr.getAttribute('data-key') || '');
      if(highlightedSet.has(key)) tr.classList.add('highlight');
    });
  }
}

function applyFilters(){
  const valA = String(document.getElementById('filterA').value || '').trim().toLowerCase();
  const valD = String(document.getElementById('filterD').value || '').trim().toLowerCase();
  filteredData = mergedData.filter(r=>{
    const aStr = String(r.A || '').toLowerCase();
    const dStr = String(r.D || '').toLowerCase();
    const aMatch = aStr.includes(valA);
    const dMatch = dStr.includes(valD);
    return aMatch && dMatch;
  });
  renderTable(filteredData);
}

// Xu·∫•t d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã
btnExport.addEventListener('click', ()=>{
  if(!filteredData.length){ alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t'); return; }
  const out = [['A','D']];
  filteredData.forEach(r=> out.push([r.A, r.D]));
  const ws = XLSX.utils.aoa_to_sheet(out);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'KetQua');
  XLSX.writeFile(wb,'LOC-TANG_Ketqua.xlsx');
});

// Xu·∫•t nh·ªØng h√†ng ƒëang ƒë∆∞·ª£c t√¥ m√†u
btnExportHighlighted.addEventListener('click', ()=>{
  if(highlightedSet.size === 0){ alert('Ch∆∞a c√≥ h√†ng n√†o ƒë∆∞·ª£c t√¥ m√†u.'); return; }
  // L·∫•y c√°c h√†ng trong mergedData c√≥ A thu·ªôc highlightedSet
  const out = [['A','D']];
  mergedData.forEach(r=>{
    if(highlightedSet.has(String(r.A))) out.push([r.A, r.D]);
  });
  if(out.length===1){ alert('Kh√¥ng t√¨m th·∫•y h√†ng t√¥ m√†u trong d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω.'); return; }
  const ws = XLSX.utils.aoa_to_sheet(out);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'KetQua_Highlighted');
  XLSX.writeFile(wb,'LOC-TANG_Highlighted.xlsx');
});

function escapeHtml(s){
  return s===null||s===undefined?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function clearAll(){
  if(!confirm('B·∫°n c√≥ mu·ªën x√≥a d·ªØ li·ªáu hi·ªán t·∫°i?')) return;
  mergedData=[]; filteredData=[]; highlightedSet.clear();
  tableWrap.innerHTML=''; actions.style.display='none'; fileInput.value='';
}
</script>
</body>
</html>
